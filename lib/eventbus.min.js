(function(a,b){if(typeof exports==="object"&&typeof module==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define("EventBus",[],b)}else{if(typeof exports==="object"){exports.EventBus=b()}else{a.EventBus=b()}}}})(this,function(){var e;var d=function(l){return l&&typeof l==="function"},i=function(l){return l&&l.constructor.name==="Array"},a=function(l,m){return function(){return m.apply(l,k(arguments))}};function g(o,n){o=o||[];var m={stop:function(p){this.isStopped=true;this.result=p},isStopped:false,result:e};for(var l in o){n(l,o[l],o,m);if(m.isStopped){break}}if(m.isStopped){return m.result}}function k(n,m,l){if(m>n.length){return[]}return[].slice.call(n,m===e?0:m,l===e?n.length:l)||[]}function c(p,m,o,l){if(typeof o=="string"||i(o)){var n=o;if(typeof o=="string"){n=o.trim().split(j.DEFAULT.EVENT_TYPE_SPLIT_EXP)}if(n.length>1){g(n,function(q,r){l[0]=r;m.apply(p,l)});return p}else{o=n[0]}}return o}var b=(function(){var l=1000;return function(){return ++l}})();var j={};j=function(){this.listeners={};this.regexListeners=[]};j.prototype={on:function(o,r,n){o=c(this,this.on,o,k(arguments));if(o==this){return this}var q=o instanceof RegExp;var m=q?o.toString():o;var l=k(arguments);if(j.DEFAULT.SHOW_LOG){console.log("on=>listener args is ",l)}var p={id:b(),scope:n||{},callback:r,args:l,regExp:o,eventType:m};if(!q){if(typeof this.listeners[m]!="undefined"){this.listeners[m].push(p)}else{this.listeners[m]=[p]}}else{this.regexListeners.push(p)}return this},off:function(p,q,t){p=c(this,this.off,p,[e,q,t]);if(p==this){return this}var n=p instanceof RegExp;var m=n?p.toString():p;var r=[];if(typeof q=="object"){t=q;q=e}var o=q==e;var s=t==e;if(j.DEFAULT.SHOW_LOG){console.log("off=>off event type:",p," all callback:",o," all scope:",s)}function l(u){return(o?true:u.callback==q)&&(s?true:u.scope==t)}if(!n){if(typeof this.listeners[m]!="undefined"){if(!(o&&s)){g(this.listeners[m],function(u,v){if(!l(v)){r.push(v)}else{}})}this.listeners[m]=r}}else{g(this.regexListeners,function(u,v){if(!(v.eventType===m&&l(v))){r.push(v)}else{}});this.regexListeners=r}return this},has:function(p,s,o){var r=p instanceof RegExp;var m=r?p.toString():p;var n=[].concat(this.listeners[m]);if(typeof s=="object"){o=s;s=e}if(n.length>0&&!r){var q=n.length;if(s===e&&o===e){return q>0}var l=g(n,function(t,v,w,u){if((o?v.scope==o:true)&&(s?v.callback==s:true)){u.stop(true)}});if(l){return true}}else{if(r){n=[].concat(this.regexListeners);var l=g(n,function(t,v,w,u){if(v.regExp.toString()==m&&(o?v.scope==o:true)&&(s?v.callback==s:true)){u.stop(true)}});if(l){return true}}}return false},emit:function(q){var m=this.eventFlow=this.eventFlow||[];var n=k(arguments);q=c(this,this.emit,q,n);if(q==this){return this}var r={id:q+"#"+b(),type:q,target:n.length>1?n[1]:{}};n=[r].concat(k(arguments,1));var p=[].concat(typeof this.listeners[q]=="undefined"?[]:this.listeners[q]);var l=this;function s(v){var t=[].concat(m);var u=false;r.stop=function(){u=true};r.isStopped=function(){return u};r.getArg=function(w){if(!i(r.args)||r.args.length-1<w){return e}return r.args[w]};r.flow={getEarlyEvent:function(){return t.slice(0,1).shift()},getClosestEvent:function(){return t.slice(0,t.length-1).pop()},getAllEvents:function(){return t.slice(0)},getEventIdsPath:function(w){return t.map(function(x){return x.id}).join(w||"==>")}};r.getLevel=function(){return t.length-1};g(v,function(x,C,A,z){if(C&&C.callback){var B=[].concat(n);if(j.DEFAULT.SHOW_LOG){console.log("emit=>event listener call arguments:",B)}r.args=[].concat(C.args);if(j.DEFAULT.SHOW_LOG){console.log("emit=>fire event listener:",C)}try{if(j.DEFAULT.SHOW_LOG){console.log("event flow:",r.flow.getEventIdsPath())}var w=l.beforeTriggerListener;if(d(w)){w.apply(l,[C].concat(B))}C.callback.apply(C.scope,B);w=l.afterTriggerListener;if(d(w)){w.apply(l,[C].concat(B))}}catch(y){u=true;l.emit(j.DEFAULT.ERROR_EVENT_TYPE,y,C,B)}if(u){z.stop()}}})}var o=[].concat(this.regexListeners);g(o,function(t,u){if(u.regExp.test(q)){p.push(u)}});m.push(r);s(p);m.pop();return this}};var f=new j();var h=function(l){return f.emit.apply(f,k(arguments))};h.fn=j.prototype;h.DEFAULT=j.DEFAULT={SHOW_LOG:false,EVENT_TYPE_SPLIT_EXP:/,|\s/,ERROR_EVENT_TYPE:"EMIT_ERROR",EXCLUDE_NAMES:["aspect","before","after","around","isFunction","isArray","hit","slice","iterator"]};h.plugin=function(l){l(h);g(j.prototype,function(m,n){if(n&&
/*!EventBus["hasOwnProperty"](key) &&*/
(!{}["hasOwnProperty"](m))&&d(n)&&j.DEFAULT.EXCLUDE_NAMES.indexOf(m)<0){h[m]=a(f,n)}})};h.plugin(function(l){l.fn.bind=l.fn.addEventListener=l.fn.on;l.fn.unbind=l.fn.removeEventListener=l.fn.off;l.fn.trigger=l.fn.dispatch=l.fn.emit;l.fn.hasEventListener=l.fn.has});h.plugin(function(l){l.fn.getCurrentEvent=function(){return[].concat(this.eventFlow).pop()};l.fn.getEarlyEvent=function(){return[].concat(this.eventFlow).shift()};l.fn.getClosestEvent=function(){return this.getCurrentEvent()?this.getCurrentEvent().flow.getClosestEvent():e}});h.plugin(function(l){l.fn.once=function(q,r,p){var m=this;var n=function(s){r.apply(this,k(arguments));m.off(q,n,p)};var o=k(arguments);o[1]=n;return m.on.apply(m,o)}});h.plugin(function(l){l.fn.flow=function(n){var o=k(arguments);if(i(n)){o=n}var m=this;g(o,function(p,q){if(q instanceof Object&&typeof q=="object"&&q.from!=e&&q.to!=e){m.redirect(q.from,q.to,q.where,q.processor)}});return m}});h.plugin(function(l){l.fn.redirect=function(n,q,r,p){var m=this;if(n==e||q==e||n==q){return m}var o=this.redirectScope=this.redirectScope||{};p=d(p)?p:function(s){s.setEmitArgs(h.slice(arguments,1))};this.on(n,(function(v,w,t){if(w==e){w=function(){return true}}if(w instanceof RegExp){var u=w;w=function(x){return u.test(x.type)}}if(d(w)){var s=[];return function(z){var x=k(arguments);if(w.apply(o,x)){var y=d(v)?v.apply(o,x):v;if(s.indexOf(t)<0&&y!=z.type&&y!=e){s.push(t);try{if(typeof y=="string"){y=y.trim().split(j.DEFAULT.EVENT_TYPE_SPLIT_EXP)}if(!(i(y))){y=[y]}g(y,function(A,D,E,C){if(D!=z.type){var B=k([].concat(x),1);z.setEmitArgs=function(F){B=F};z.getEmitArgs=function(){return[].concat(B)};z.getOriginType=function(){return n};z.getEndpoint=function(){return D};z.isRedirect=function(){return true};z.endpoints=z.endpoints||[];z.endpoints.push(D);p.apply(o,x);B=(i(B))?[""].concat(B):[].concat(x);B[0]=D;if(j.DEFAULT.SHOW_LOG){console.log("redirect=>redirect id:",z.id," origin:",n," ==> endpoint:",D)}m.emit.apply(m,B);if(z.isStopped()){C.stop(true)}}})}finally{s.pop()}}else{throw"redirect origin:"+n.toString()+" => endpoint:"+v.toString()+"  is looping!"}}}}else{return function(x){if(j.DEFAULT.SHOW_LOG){console.log("redirect=>redirect condition must set function or RegExp!")}}}})(q,r,b()),o);return m}});h.plugin(function(n){function m(v,u,s,t){var x=v[u];var w=u=="around";var y;if(w){var r=s(function(){return x.advice(this,arguments)});y={remove:function(){if(r){r=v=s=null}},advice:function(A,z){return r?r.apply(A,z):x.advice(A,z)}}}else{y={remove:function(){if(y.advice){var A=y.previous;var z=y.next;if(!z&&!A){delete v[u]}else{if(A){A.next=z}else{v[u]=z}if(z){z.previous=A}}v=s=y.advice=null}},id:v.nextId++,advice:s,receiveArguments:t}}if(x&&!w){if(u=="after"){while(x.next&&(x=x.next)){}x.next=y;y.previous=x}else{if(u=="before"){v[u]=y;y.next=x;x.previous=y}}}else{v[u]=y}return y}function l(r){return function(y,s,t,v){var x=y[s],w;if(!x||x.target!=y){y[s]=w=function(){var B=w.nextId;var z=arguments;var C=w.before;while(C){if(C.advice){z=C.advice.apply(this,z)||z}C=C.next}if(w.around){var A=w.around.advice(this,z)}var D=w.after;while(D&&D.id<B){if(D.advice){if(D.receiveArguments){var E=D.advice.apply(this,z);A=E===e?A:E}else{A=D.advice.call(this,A,z)}}D=D.next}return A};if(x){w.around={advice:function(A,z){return x.apply(A,z)}}}w.target=y;w.nextId=w.nextId||0}var u=m((w||x),r,t,v);t=null;return u}}var q=l("after");var p=l("before");var o=l("around");n.before=function(s,r){return p(f,s,r)};n.after=function(s,r,t){return q(f,s,r,t)};n.around=function(r,s){return n.aspect(f,r,s)};n.aspect={around:o,before:p,after:q}});h.plugin(function(l){l.fn.beforeTriggerListener=function(o,n,p){};l.fn.afterTriggerListener=function(o,n,p){};l.DEFAULT.EXCLUDE_NAMES.push("beforeTriggerListener","afterTriggerListener");function m(o,p,q,n){if(typeof o=="string"){o=new RegExp(o)}return l.isFunction(q)?(o.test(p.type)&&q.apply(this,n)):o.test(p.type)}l.beforeTriggerListener=function(n,o,p){return l.before("beforeTriggerListener",function(r,q){if(m(n,q,p,k(arguments))){return o.apply(this,l.slice(arguments))}})};l.afterTriggerListener=function(n,o,p){return l.before("afterTriggerListener",function(r,q){if(m(n,q,p,k(arguments))){return o.apply(this,l.slice(arguments))}})}});h.plugin(function(l){l.slice=k;l.nextId=b;l.iterator=g;l.hit=a;l.isFunction=d;l.isArray=i});return h});